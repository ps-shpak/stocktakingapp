# API

## Stocktaking API

Stocktaking API обсуживает основные задачи по созданию, изменению и удалению предметов и владельцев.

Для внешнего трафика он доступен в виде REST API с префиксом `/api/`:

* при локальной разработке: `http://localhost/api`
* в развёрнутом окружении: `https://example.com/api`

Документация к REST API находится в `"/stocktakingapi/api.swagger.json"` (генерируется скриптом `"/stocktakingbackend/bin/generate-api-docs"`).

API реализуется контейнером `stocktakingbackend` в двух форматах:

* на порту `8081` - в формате GRPC, API описан в файле `"stocktakingapi/api.proto"`
** GRPC напрямую недоступен в браузерах, но может использоваться другими сервисами
* на порту `8082` по пути `/stocktaking/...` - в формате REST, API описан в автогенерируемом файле `"/stocktakingapi/api.swagger.json"`
** этот формат напрямую доступен из браузера

Пример использования:

```bash
curl -L http://localhost/stocktaking/items
```

## Labeling API

Labeling API обслуживает генерацию QR кодов, содержащих описание предмета в формате JSON.

### Метод /labeling/items для генерации QR кода

Метод `/labeling/items` генерирует HTML с наклейками для идентификации предметов через мобильное приложение. Каждая наклейка состоит из QR-кода и текста (ссылки).

GET-параметры запроса:

* `id` - один или несколько идентификаторов (UUID) предметов, параметр может повторяться: `example.com/labeling/items?id=123&id=456&id=789`

Метод возвращает HTML-страницу (файл типа `text/html`), пригодную для печати наклеек на имущество.

### Метод /labeling/item/{id}/qr для генерации страницы на печать

Метод `/labeling/item/{id}/qr` генерирует изображение с QR кодом, в котором сохранён JSON с информацией о предмете.

GET-параметры запроса:

* `size` - желаемый размер изображения, по умолчанию 256

Метод возвращает изображение `image/png`, содержащее QR код, в котором зашифрован JSON следующего формата:

```json
{
    "url": "example.com/stocktaking/item?id=$UUID",
    "name": "человекочитаемое имя предмета",
    "owner": "имя владельца",
    "owner_id": "uuid владельца"
}
```

В этом QR коде из всех полей в хранимом JSON обязательным является только поле "url", остальные могут быть пропущены, если доступного объёма QR кода было недостаточно для хранения всей информации.